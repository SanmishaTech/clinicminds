generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Approval status for Indents: two-step approval and completion


model User {
  id                        Int                @id @default(autoincrement())
  name                      String?
  email                     String             @unique
  passwordHash              String // was: password
  role                      String
  profilePhoto              String?
  emailVerified             DateTime?
  verificationToken         String?            @unique
  verificationTokenExpiry   DateTime?
  status                    Boolean            @default(true)
  lastLogin                 DateTime?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  refreshTokens             RefreshToken[]

  franchise                  Franchise?
  team                       Team?
  stockTransactionsCreated    StockTransaction[]
  franchiseFeePaymentsCreated FranchiseFeePayment[] @relation("FranchiseFeePaymentCreatedBy")

  @@index([role])
  @@map("users")
}

model RefreshToken {
  id         Int       @id @default(autoincrement())
  token      String    @unique
  userId     Int
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  revokedAt  DateTime?
  replacedBy String?

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Franchise {
  id           Int      @id @default(autoincrement())
  name         String
  addressLine1 String?
  addressLine2 String?
  city         String
  state        String
  pincode      String
  contactNo    String
  contactEmail String
  franchiseFeeAmount Decimal? @db.Decimal(10, 2)
   
  userMobile String
  userId     Int    @unique
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  sales      Sale[]
  patients   Patient[]
  team       Team[]
  room       Room[]
  appointments Appointment[]
  stockTransactions StockTransaction[]
  stockLedgerEntries StockLedger[]
  stockBalances StockBalance[]
  stockBatchBalances StockBatchBalance[]
  franchiseFeePayments FranchiseFeePayment[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([city])
  @@index([state])
  @@map("franchises")
}

model FranchiseFeePayment {
  id             Int      @id @default(autoincrement())
  franchiseId    Int
  franchise      Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  paymentDate    DateTime
  amount         Decimal  @db.Decimal(10, 2)
  paymentMode    String
  payerName      String?
  contactNumber  String?
  utrNumber      String?
  chequeNumber   String?
  notes          String?  @db.Text
  createdByUserId Int
  createdByUser  User     @relation("FranchiseFeePaymentCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())

  @@index([franchiseId])
  @@index([paymentDate])
  @@index([createdByUserId])
  @@map("franchise_fee_payments")
}

model State {
  id        Int      @id @default(autoincrement())
  state     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cities City[]
  patients Patient[]

  @@map("states")
}

model City {
  id        Int      @id @default(autoincrement())
  city      String
  stateId   Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  state            State?    @relation(fields: [stateId], references: [id])
  patients         Patient[]

  @@unique([city, stateId])
  @@index([stateId])
  @@map("cities")
}

model Service{
  id          Int      @id @default(autoincrement())
  name        String   @unique
  rate        Decimal  @db.Decimal(10, 2)
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  packageDetails PackageDetail[]
  consultationDetails ConsultationDetail[]

  @@index([name])                    // For searching by name
  @@index([rate])                    // For sorting by rate
  @@index([createdAt])                // For sorting by creation date
  @@map("services")
}

model Brand{
  id          Int      @id @default(autoincrement())
  name        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  medicines Medicine[]

  @@index([name])
  @@map("brands")
}

model Medicine{
  id          Int      @id @default(autoincrement())
  name        String   @unique
  brandId     Int
  brand       Brand    @relation(fields: [brandId], references: [id])
  rate        Decimal  @db.Decimal(10, 2)
  mrp         Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  saleDetail SaleDetail[]
  packageMedicines PackageMedicine[]
  consultationMedicines ConsultationMedicine[]
  stockLedgerEntries StockLedger[]
  stockBalances StockBalance[]
  stockBatchBalances StockBatchBalance[]

  @@index([name])                    // For searching by name
  @@index([brandId])                   // For filtering by brand
  @@index([rate])                    // For sorting by rate
  @@index([mrp])                     // For sorting by mrp
  @@index([createdAt])                // For sorting by creation date
  @@map("medicines")
}

model Sale{
  id          Int      @id @default(autoincrement())
  invoiceNo   String
  invoiceDate DateTime
  franchiseId Int
  franchise   Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  saleDetails SaleDetail[]
  stockTransaction StockTransaction?
  totalAmount Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([invoiceNo])
  @@index([franchiseId])             // For filtering by franchise
  @@index([invoiceDate])             // For sorting/filtering by date
  @@index([franchiseId, invoiceDate]) // Composite for franchise sales reports
  @@index([createdAt])                // For recent sales
  @@map("sales")
}

model SaleDetail{
  id          Int      @id @default(autoincrement())
  saleId      Int
  sale        Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  medicineId  Int
  medicine    Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  batchNumber String?
  expiryDate  DateTime?
  quantity    Int
  rate        Decimal  @db.Decimal(10, 2)
  amount      Decimal  @db.Decimal(10, 2)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([saleId])
  @@index([medicineId])
  @@index([saleId, medicineId])
  @@map("sale_details")
}

model Package {
  id             Int              @id @default(autoincrement())
  name           String           @unique
  totalAmount    Decimal          @db.Decimal(10, 2)
  discountPercent Decimal         @default(0) @db.Decimal(5, 2)
  packageDetails PackageDetail[]
  packageMedicines PackageMedicine[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([name])
  @@map("packages")
}

model PackageDetail {
  id          Int      @id @default(autoincrement())
  packageId   Int
  package     Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)
  serviceId   Int
  service     Service  @relation(fields: [serviceId], references: [id])
  description String?  @db.Text
  qty         Int
  rate        Decimal  @db.Decimal(10, 2)
  amount      Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([packageId])
  @@index([serviceId])
  @@map("package_details")
}

model PackageMedicine {
  id        Int      @id @default(autoincrement())
  packageId Int
  package   Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)
  medicineId Int
  medicine  Medicine @relation(fields: [medicineId], references: [id])
  qty       Int
  rate      Decimal  @db.Decimal(10, 2)
  amount    Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([packageId])
  @@index([medicineId])
  @@map("package_medicines")
}

model Patient {
  id                            Int      @id @default(autoincrement())
  patientNo                     String   @unique
  franchiseId                   Int?
  teamId                        Int?
  firstName                     String
  middleName                    String?
  lastName                      String
  dateOfBirth                   DateTime?
  age                           Int?
  gender                        String?
  bloodGroup                    String?
  height                        String?
  weight                        String?
  bmi                           String?
  address                       String?  @db.Text
  stateId                       Int?
  cityId                        Int?
  pincode                       String?
  mobile                        String
  email                         String?
  aadharNo                      String?
  occupation                    String?
  maritalStatus                 String?
  contactPersonName             String?
  contactPersonRelation         String?
  contactPersonAddress          String?
  contactPersonMobile           String?
  contactPersonEmail            String?
  medicalInsurance              Boolean @default(false)
  primaryInsuranceName          String?
  primaryInsuranceHolderName    String?
  primaryInsuranceId            String?
  secondaryInsuranceName        String?
  secondaryInsuranceHolderName  String?
  secondaryInsuranceId          String?

  medicalHistory                PatientMedicalHistory?
  referedBy                     String?
  balanceAmount                 Float    @default(0)
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt

  franchise                     Franchise? @relation(fields: [franchiseId], references: [id], onDelete: SetNull)
  team                          Team? @relation(fields: [teamId], references: [id], onDelete: SetNull)
  appointments                  Appointment[]
  state State? @relation(fields: [stateId], references: [id])
  city  City? @relation(fields: [cityId], references: [id])

  @@index([patientNo])
  @@index([firstName])
  @@index([middleName])
  @@index([lastName])
  @@index([franchiseId])
  @@index([gender])
  @@index([stateId])
  @@index([cityId])
  @@index([mobile])
  @@map("patients")
}

model PatientMedicalHistory {
  id                    Int      @id @default(autoincrement())
  patientId              Int      @unique
  patient               Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  reasonForVisit         String?  @db.Text
  heardAboutUs           String?  @db.Text
  pharmacyName           String?  @db.Text
  pharmacyLocation       String?  @db.Text

  diet                  String?  @db.Text
  smokes                Boolean  @default(false)
  smokingUnitsPerDay    String?  @db.Text
  drinksAlcohol         Boolean  @default(false)
  alcoholHowMuch        String?  @db.Text
  alcoholFrequency      String?  @db.Text

  hasCurrentMedications  Boolean  @default(false)
  currentMedications     Json?
  hasMedicationAllergies Boolean  @default(false)
  otherAllergies         String?  @db.Text

  hadAllergyTest         Boolean  @default(false)
  allergyTestDetails     String?  @db.Text

  medicalHistory         Json?
  medicalHistoryOther    String?  @db.Text

  hasSurgicalHistory     Boolean  @default(false)
  surgicalHistory        Json?

  familyHistory          Json?
  familyHistoryOther     String?  @db.Text

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([patientId])
  @@map("patient_medical_histories")
}

model PatientSequence {
  dateKey    String   @id
  lastNumber Int      @default(0)
  updatedAt  DateTime @updatedAt

  @@map("patient_sequences")
}

model Room {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  
  franchiseId Int
  franchise   Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("rooms")
}

model Team{
  id            Int      @id @default(autoincrement())
  name          String
  joiningDate   DateTime?
  leavingDate   DateTime?
  addressLine1  String   @db.Text
  addressLine2  String?  @db.Text
  city          String
  state         String
  pincode       String
  userMobile    String
  userId        Int    @unique
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  franchiseId   Int
  franchise     Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  patients      Patient[]
  appointments  Appointment[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([city])                    // For filtering by city
  @@index([state])                   // For filtering by state
  @@index([userMobile])              // For searching by user mobile
  @@index([joiningDate])             // For sorting by joining date
  @@index([leavingDate])             // For sorting by leaving date
  @@index([createdAt])               // For sorting by creation date
  @@index([userId])                  // For user relation queries
  @@map("teams")
}

model Appointment{
  id                    Int       @id @default(autoincrement())
  franchiseId           Int
  franchise             Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  patientId             Int
  patient               Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointmentDateTime   DateTime
  teamId                Int
  team                  Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  visitPurpose          String?   @db.Text
  
  consultation          Consultation?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model Consultation{
  id                    Int       @id @default(autoincrement())
  appointmentId         Int       @unique
  appointment           Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  complaint             String?   @db.Text
  remarks               String?   @db.Text
  diagnosis             String?   @db.Text
  casePaperUrl          String?   @db.Text
  nextFollowUpDate      DateTime?
  totalAmount           Decimal   @db.Decimal(10, 2)
  consultationDetails   ConsultationDetail[]
  consultationMedicines ConsultationMedicine[]
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model ConsultationDetail{
  id                    Int       @id @default(autoincrement())
  consultationId        Int
  consultation          Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  serviceId             Int?
  service               Service?        @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  description           String?   @db.Text
  qty                   Int
  rate                  Decimal   @db.Decimal(10, 2)
  amount                Decimal   @db.Decimal(10, 2)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model ConsultationMedicine{
  id                    Int       @id @default(autoincrement())
  consultationId        Int
  consultation          Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  medicineId            Int?
  medicine              Medicine? @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  qty                   Int
  mrp                   Decimal   @db.Decimal(10, 2)
  amount                Decimal   @db.Decimal(10, 2)
  doses                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model StockTransaction {
  id              Int      @id @default(autoincrement())
  txnType         String
  txnNo           String   @unique
  txnDate         DateTime
  franchiseId     Int
  franchise       Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  createdByUserId Int
  createdByUser   User     @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  saleId          Int?     @unique
  sale            Sale?    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  ledgerEntries   StockLedger[]

  @@index([franchiseId])
  @@index([txnType])
  @@index([txnDate])
  @@index([createdByUserId])
  @@map("stock_transactions")
}

model StockLedger {
  id             Int      @id @default(autoincrement())
  transactionId  Int
  transaction    StockTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  franchiseId    Int
  franchise      Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  medicineId     Int
  medicine       Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  batchNumber    String?
  expiryDate     DateTime?
  qtyChange      Int
  rate           Decimal? @db.Decimal(10, 2)
  amount         Decimal? @db.Decimal(10, 2)
  createdAt      DateTime @default(now())

  @@index([transactionId])
  @@index([franchiseId])
  @@index([medicineId])
  @@index([franchiseId, medicineId])
  @@map("stock_ledger")
}

model StockBatchBalance {
  id          Int      @id @default(autoincrement())
  franchiseId Int
  franchise   Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  medicineId  Int
  medicine    Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  batchNumber String
  expiryDate  DateTime
  quantity    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([franchiseId, medicineId, batchNumber, expiryDate])
  @@index([franchiseId])
  @@index([medicineId])
  @@index([franchiseId, medicineId])
  @@index([expiryDate])
  @@map("stock_batch_balances")
}

model StockBalance {
  id          Int      @id @default(autoincrement())
  franchiseId Int
  franchise   Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  medicineId  Int
  medicine    Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  quantity    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([franchiseId, medicineId])
  @@index([franchiseId])
  @@index([medicineId])
  @@map("stock_balances")
}
