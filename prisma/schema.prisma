generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Approval status for Indents: two-step approval and completion


model User {
  id                        Int                @id @default(autoincrement())
  name                      String?
  email                     String             @unique
  passwordHash              String // was: password
  role                      String
  profilePhoto              String?
  emailVerified             DateTime?
  verificationToken         String?            @unique
  verificationTokenExpiry   DateTime?
  status                    Boolean            @default(true)
  lastLogin                 DateTime?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  refreshTokens             RefreshToken[]

  franchise                  Franchise?
  team                       Team?

  @@index([role])
  @@map("users")
}

model RefreshToken {
  id         Int       @id @default(autoincrement())
  token      String    @unique
  userId     Int
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  revokedAt  DateTime?
  replacedBy String?

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Franchise {
  id           Int      @id @default(autoincrement())
  name         String
  addressLine1 String?
  addressLine2 String?
  city         String
  state        String
  pincode      String
  contactNo    String
  contactEmail String
   
  userMobile String
  userId     Int    @unique
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  sales      Sale[]
  patients   Patient[]
  team       Team[]
  room       Room[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([city])
  @@index([state])
  @@map("franchises")
}

model State {
  id        Int      @id @default(autoincrement())
  state     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cities City[]
  patients Patient[]

  @@map("states")
}

model City {
  id        Int      @id @default(autoincrement())
  city      String
  stateId   Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  state            State?    @relation(fields: [stateId], references: [id])
  patients         Patient[]

  @@unique([city, stateId])
  @@index([stateId])
  @@map("cities")
}

model Service{
  id          Int      @id @default(autoincrement())
  name        String   @unique
  rate        Decimal  @db.Decimal(10, 2)
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  packageDetails PackageDetail[]

  @@index([name])                    // For searching by name
  @@index([rate])                    // For sorting by rate
  @@index([createdAt])                // For sorting by creation date
  @@map("services")
}

model Brand{
  id          Int      @id @default(autoincrement())
  name        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  medicines Medicine[]

  @@index([name])
  @@map("brands")
}

model Medicine{
  id          Int      @id @default(autoincrement())
  name        String   @unique
  brandId     Int
  brand       Brand    @relation(fields: [brandId], references: [id])
  rate        Decimal  @db.Decimal(10, 2)
  mrp         Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  saleDetail SaleDetail[]
  packageMedicines PackageMedicine[]

  @@index([name])                    // For searching by name
  @@index([brandId])                   // For filtering by brand
  @@index([rate])                    // For sorting by rate
  @@index([mrp])                     // For sorting by mrp
  @@index([createdAt])                // For sorting by creation date
  @@map("medicines")
}

model Sale{
  id          Int      @id @default(autoincrement())
  invoiceNo   String
  invoiceDate DateTime
  franchiseId Int
  franchise   Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  saleDetails SaleDetail[]
  totalAmount Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([invoiceNo])
  @@index([franchiseId])             // For filtering by franchise
  @@index([invoiceDate])             // For sorting/filtering by date
  @@index([franchiseId, invoiceDate]) // Composite for franchise sales reports
  @@index([createdAt])                // For recent sales
  @@map("sales")
}

model SaleDetail{
  id          Int      @id @default(autoincrement())
  saleId      Int
  sale        Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  medicineId  Int
  medicine    Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  quantity    Int
  rate        Decimal  @db.Decimal(10, 2)
  amount      Decimal  @db.Decimal(10, 2)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([saleId])
  @@index([medicineId])
  @@index([saleId, medicineId])
  @@map("sale_details")
}

model Package {
  id             Int              @id @default(autoincrement())
  name           String           @unique
  totalAmount    Decimal          @db.Decimal(10, 2)
  packageDetails PackageDetail[]
  packageMedicines PackageMedicine[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([name])
  @@map("packages")
}

model PackageDetail {
  id          Int      @id @default(autoincrement())
  packageId   Int
  package     Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)
  serviceId   Int
  service     Service  @relation(fields: [serviceId], references: [id])
  description String?  @db.Text
  qty         Int
  rate        Decimal  @db.Decimal(10, 2)
  amount      Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([packageId])
  @@index([serviceId])
  @@map("package_details")
}

model PackageMedicine {
  id        Int      @id @default(autoincrement())
  packageId Int
  package   Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)
  medicineId Int
  medicine  Medicine @relation(fields: [medicineId], references: [id])
  qty       Int
  rate      Decimal  @db.Decimal(10, 2)
  amount    Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([packageId])
  @@index([medicineId])
  @@map("package_medicines")
}

model Patient {
  id                            Int      @id @default(autoincrement())
  patientNo                     String   @unique
  franchiseId                   Int?
  teamId                        Int?
  firstName                     String
  middleName                    String
  lastName                      String
  dateOfBirth                   DateTime?
  age                           Int?
  gender                        String
  bloodGroup                    String
  height                        String?
  weight                        String?
  bmi                           String?
  address                       String
  stateId                       Int
  cityId                        Int
  pincode                       String?
  mobile                        String
  email                         String?
  aadharNo                      String
  occupation                    String?
  maritalStatus                 String?
  contactPersonName             String?
  contactPersonRelation         String?
  contactPersonAddress          String?
  contactPersonMobile           String?
  contactPersonEmail            String?
  medicalInsurance              Boolean @default(false)
  primaryInsuranceName          String?
  primaryInsuranceHolderName    String?
  primaryInsuranceId            String?
  secondaryInsuranceName        String?
  secondaryInsuranceHolderName  String?
  secondaryInsuranceId          String?

  medicalHistory                PatientMedicalHistory?

  balanceAmount                 Float    @default(0)
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt

  franchise                     Franchise? @relation(fields: [franchiseId], references: [id], onDelete: SetNull)
  team                          Team? @relation(fields: [teamId], references: [id], onDelete: SetNull)
  state State @relation(fields: [stateId], references: [id])
  city  City  @relation(fields: [cityId], references: [id])

  @@index([patientNo])
  @@index([firstName])
  @@index([middleName])
  @@index([lastName])
  @@index([franchiseId])
  @@index([gender])
  @@index([stateId])
  @@index([cityId])
  @@index([mobile])
  @@map("patients")
}

model PatientMedicalHistory {
  id                    Int      @id @default(autoincrement())
  patientId              Int      @unique
  patient               Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  reasonForVisit         String?  @db.Text
  heardAboutUs           String?  @db.Text
  pharmacyName           String?  @db.Text
  pharmacyLocation       String?  @db.Text

  diet                  String?  @db.Text
  smokes                Boolean  @default(false)
  smokingUnitsPerDay    String?  @db.Text
  drinksAlcohol         Boolean  @default(false)
  alcoholHowMuch        String?  @db.Text
  alcoholFrequency      String?  @db.Text

  hasCurrentMedications  Boolean  @default(false)
  currentMedications     Json?
  hasMedicationAllergies Boolean  @default(false)
  otherAllergies         String?  @db.Text

  hadAllergyTest         Boolean  @default(false)
  allergyTestDetails     String?  @db.Text

  medicalHistory         Json?
  medicalHistoryOther    String?  @db.Text

  hasSurgicalHistory     Boolean  @default(false)
  surgicalHistory        Json?

  familyHistory          Json?
  familyHistoryOther     String?  @db.Text

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([patientId])
  @@map("patient_medical_histories")
}

model PatientSequence {
  dateKey    String   @id
  lastNumber Int      @default(0)
  updatedAt  DateTime @updatedAt

  @@map("patient_sequences")
}

model Room {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  
  franchiseId Int
  franchise   Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("rooms")
}

model Team{
  id            Int      @id @default(autoincrement())
  name          String
  joiningDate   DateTime?
  leavingDate   DateTime?
  addressLine1  String   @db.Text
  addressLine2  String?  @db.Text
  city          String
  state         String
  pincode       String
  userMobile    String
  userId        Int    @unique
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  franchiseId   Int
  franchise     Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  patients      Patient[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([city])                    // For filtering by city
  @@index([state])                   // For filtering by state
  @@index([userMobile])              // For searching by user mobile
  @@index([joiningDate])             // For sorting by joining date
  @@index([leavingDate])             // For sorting by leaving date
  @@index([createdAt])               // For sorting by creation date
  @@index([userId])                  // For user relation queries
  @@map("teams")
}

